<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8"><title>(shrikant-sharat)</title><meta name="author" content="Shrikant Sharat Kandula">
<link rel="stylesheet" type="text/css" href="index.css" media="all">
</head>
<body><header class="top"><a class="brand" href="http://sharats.me/">(shrikant-sharat)</a><div style="float: right;"><a href="http://sharats.me/about.html">About</a><a href="http://sharats.me/labs.html">Labs</a><a href="http://sharats.me/archives.html">Archives</a><a href="http://sharats.me/tags.html">Tags</a><a href="http://sharats.me/feeds/all.atom.xml">Atom Feed</a></div></header><section><article><article><header><h1>The ever useful and neat subprocess module</h1><time>29 Apr, 2012</time></header><p></p><p>Python's <a href="http://docs.python.org/library/subprocess.html">subprocess</a> module is one of my favourite modules in the standard library. If you have ever done some decent amount of coding in python, you might have encountered it. This module is used for dealing with external commands, intended to be a replacement to the old <a href="http://docs.python.org/library/os.html#os.system"><code>os.system</code></a> and the like.</p><p>The most trivial use might be to get the output of a small shell command like <code>ls</code> or <code>ps</code>. Not that this is the best way to get a list of files in a directory (think <a href="http://docs.python.org/library/os.html#os.listdir"><code>os.listdir</code></a>), but you get the point.</p><p>I am going to put my notes and experiences about this module here. Please note, I wrote this with Python 2.7 in mind. Things <strong>are</strong> slightly different in other versions (even 2.6). If you find any errors or suggestions, please let me know.</p><div class="toc"><ul><li><a href="#a-simple-usage">A simple usage</a></li><li><a href="#popen-class">Popen class</a></li><li><a href="#running-via-the-shell">Running via the shell</a></li><li><a href="#getting-the-return-code-aka-exit-status">Getting the return code (aka exit status)</a></li><li><a href="#io-streams">IO Streams</a><ul><li><a href="#reading-error-stream">Reading error stream</a></li><li><a href="#watching-both-stdout-and-stderr">Watching both stdout and stderr</a></li></ul></li><li><a href="#passing-an-environment">Passing an environment</a><ul><li><a href="#merge-with-current-environment">Merge with current environment</a></li><li><a href="#unicode">Unicode</a></li></ul></li><li><a href="#execute-in-a-different-working-directory">Execute in a different working directory</a></li><li><a href="#killing-and-dieing">Killing and dieing</a><ul><li><a href="#auto-kill-on-death">Auto-kill on death</a></li></ul></li><li><a href="#launch-commands-in-a-terminal-emulator">Launch commands in a terminal emulator</a><ul><li><a href="#linux">Linux</a></li><li><a href="#windows">Windows</a></li></ul></li><li><a href="#conclusion">Conclusion</a></li></ul></div><h1 id="a-simple-usage">A simple usage</h1><p>For the sake of providing context, lets run the <code>ls</code> command from subprocess and get its output</p><div class="codehilite"><pre><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="n">ls_output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">'ls'</span><span class="p">])</span>
</pre></div><p>I'll cover getting output from a command in detail later. To give more command line arguments,</p><div class="codehilite"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">'ls'</span><span class="p">,</span> <span class="s">'-l'</span><span class="p">])</span>
</pre></div><p>The first item in the list is the executable and rest are its command line arguments (<code>argv</code> equivalent). No quirky shell quoting and complex nested quote rules to digest. Just a plain python list.</p><p>However, not having shell quoting implies you don't also have the shell niceties. Like piping for one. The following won't work the way one would expect it to.</p><div class="codehilite"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">'ls'</span><span class="p">,</span> <span class="s">'|'</span><span class="p">,</span> <span class="s">'wc'</span><span class="p">,</span> <span class="s">'-l'</span><span class="p">])</span>
</pre></div><p>Here, the <code>ls</code> command gets its first command as <code>|</code> and I have no idea what ls would do with it. Perhaps complain that no such file exists. So, instead, we have to use the <code>shell</code> boolean argument. More later down in the article.</p><h1 id="popen-class">Popen class</h1><p>If there's just one thing in the subprocess module that you should be concerned with, its the <a href="http://docs.python.org/library/subprocess.html#subprocess.Popen"><code>Popen</code></a> class. The other functions like <a href="http://docs.python.org/library/subprocess.html#subprocess.call"><code>call</code></a>, <a href="http://docs.python.org/library/subprocess.html#subprocess.check_call"><code>check_output</code></a>, and <a href="http://docs.python.org/library/subprocess.html#subprocess.check_call"><code>check_call</code></a> use <code>Popen</code> internally. Here's the signature from the docs.</p><div class="codehilite"><pre><span class="k">class</span> <span class="nc">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">stdout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">preexec_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">startupinfo</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">creationflags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div><p>I suggest you read the docs for this class. As with all python docs, its really good.</p><h1 id="running-via-the-shell">Running via the shell</h1><p>Subprocess can also run command-line instructions via a shell program. This is usually <code>dash</code>/<code>bash</code> on Linux and <code>cmd</code> on windows.</p><div class="codehilite"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">'ls | wc -l'</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div><p>Notice that in this case we pass a string, not a list. This is because we want the shell to interpret the whole of our command. You can even use shell style quoting if you like. It is up to the shell to decide how to best split the command line into executable and command line arguments.</p><blockquote><p>On windows, if you pass a list for args, it will be turned into a string using the same rules as the MS C runtime. See the doc-string for <code>subprocess.list2cmdline</code> for more on this. Whereas on unix-like systems, even if you pass a string, its turned into a list of one item :).</p></blockquote><p>The behaviour of the <code>shell</code> argument can sometimes be confusing so I'll try to clear it a bit here. Something I wished I had when I first encountered this module.</p><p>Firstly, lets consider the case where <code>shell</code> is set to <code>False</code>, the default. In this case, if <code>args</code> is a string, it is assumed to be the name of the executable file. Even if it contains spaces. Consider the following.</p><div class="codehilite"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">'ls -l'</span><span class="p">)</span>
</pre></div><p>This won't work because subprocess is looking for an executable file called <code>ls -l</code>, but obviously can't find it. However, if <code>args</code> is a list, then the first item in this list is considered as the executable and the rest of the items in the list are passed as command line arguments to the program.</p><div class="codehilite"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">'ls'</span><span class="p">,</span> <span class="s">'-l'</span><span class="p">])</span>
</pre></div><p>does what you think it will.</p><p>Second case, with <code>shell</code> set to <code>True</code>, the program that actually gets executed is the OS default shell, <code>/bin/sh</code> on Linux and <code>cmd.exe</code> on windows. This can be changed with the <code>executable</code> argument.</p><p>When using the shell, <code>args</code> is usually a string, something that will be parsed by the shell program. The <code>args</code> string is passed as a command line argument to the shell (with a <code>-c</code> option on Linux) such that the shell will interpret it as a shell command sequence and process it accordingly. This means you can use all the shell builtins and goodies that your shell offers.</p><div class="codehilite"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">'ls -l'</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div><p>is similar to</p><div class="codehilite"><pre><span class="nv">$ </span>/bin/sh -c <span class="s1">'ls -l'</span>
</pre></div><p>In the same vein, if you pass a list as <code>args</code> with <code>shell</code> set to <code>True</code>, all items in the list are passed as command line arguments to the shell.</p><div class="codehilite"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">'ls'</span><span class="p">,</span> <span class="s">'-l'</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div><p>is similar to</p><div class="codehilite"><pre><span class="nv">$ </span>/bin/sh -c ls -l
</pre></div><p>which is the same as</p><div class="codehilite"><pre><span class="nv">$ </span>/bin/sh -c ls
</pre></div><p>since <code>/bin/sh</code> takes just the argument next to <code>-c</code> as the command line to execute.</p><h1 id="getting-the-return-code-aka-exit-status">Getting the return code (aka exit status)</h1><p>If you want to run an external command and its return code is all you're concerned with, the <a href="http://docs.python.org/library/subprocess.html#subprocess.call"><code>call</code></a> and <a href="http://docs.python.org/library/subprocess.html#subprocess.check_call"><code>check_call</code></a> functions are what you're looking for. They both return the return code after running the command. The difference is, <code>check_call</code> raises a <code>CalledProcessError</code> if the return code is non-zero.</p><p>If you've read the docs for these functions, you'll see that its not recommended to use <code>stdout=PIPE</code> or <code>stderr=PIPE</code>. And if you don't, the <code>stdout</code> and <code>stderr</code> of the command are just redirected to the parent's (Python VM in this case) streams.</p><p>If that is not what you want, you have to use the <code>Popen</code> class.</p><div class="codehilite"><pre><span class="n">proc</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="s">'ls'</span><span class="p">)</span>
</pre></div><p>The moment the <code>Popen</code> class is instantiated, the command starts running. You can wait for it and after its done, access the return code via the <a href="http://docs.python.org/library/subprocess.html#subprocess.Popen.returncode"><code>returncode</code></a> attribute.</p><div class="codehilite"><pre><span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="k">print</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span>
</pre></div><p>If you are trying this out in a python REPL, you won't see a need to call <a href="http://docs.python.org/library/subprocess.html#subprocess.Popen.wait"><code>.wait()</code></a> since you can just wait yourself in the REPL till the command is finished and then access the <code>returncode</code>. Surprise!</p><div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="s">'ls'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">file1</span> <span class="n">file2</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span>
<span class="bp">None</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c"># wat?</span>
</pre></div><p>The command is definitely finished. Why don't we have a return code?</p><div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="mi">0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span>
<span class="mi">0</span>
</pre></div><p>The reason for this is the <code>returncode</code> is not automatically set when a process ends. You have to call <code>.wait</code> or <a href="http://docs.python.org/library/subprocess.html#subprocess.Popen.poll"><code>.poll</code></a> to realize if the program is done and set the <code>returncode</code> attribute.</p><h1 id="io-streams">IO Streams</h1><p>The simplest way to get the output of a command, as seen previously, is to use the <a href="http://docs.python.org/library/subprocess.html#subprocess.check_call"><code>check_output</code></a> function.</p><div class="codehilite"><pre><span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">'ls'</span><span class="p">)</span>
</pre></div><p>Notice the <code>check_</code> prefix in the function name? Ring any bell? That's right, this function will raise a <code>CalledProcessError</code> if the return code is non-zero.</p><p>This may not always be the best solution to get the output from a command. If you do get a <code>CalledProcessError</code> from this function call, unless you have the contents of <code>stderr</code> you probably have little idea what went wrong. You'll want to know what's written to the command's <code>stderr</code>.</p><h2 id="reading-error-stream">Reading error stream</h2><p>There are two ways to get the error output. First is redirecting <code>stderr</code> to <code>stdout</code> and only being concerned with <code>stdout</code>. This can be done by setting the <code>stderr</code> argument to <a href="http://docs.python.org/library/subprocess.html#subprocess.STDOUT"><code>subprocess.STDOUT</code></a>.</p><p>Second is to create a <code>Popen</code> object with <code>stderr</code> set to <a href="http://docs.python.org/library/subprocess.html#subprocess.PIPE"><code>subprocess.PIPE</code></a> (optionally along with <code>stdout</code> argument) and read from its <code>stderr</code> attribute which is a readable file-like object. There is also a convenience method on <code>Popen</code> class, called <code>.communicate</code>, which optionally takes a string to be sent to the process's <code>stdin</code> and returns a tuple of <code>(stdout_content, stderr_content)</code>.</p><h2 id="watching-both-stdout-and-stderr">Watching both <code>stdout</code> and <code>stderr</code></h2><p>However, all of these assume that the command runs for some time, prints out a couple of lines of output and exits, so you can get the output(s) in strings. This is sometimes not the case. If you want to run a network intensive command like an svn checkout, which prints each file as and when downloaded, you need something better.</p><p>The initial solution one can think of is this.</p><div class="codehilite"><pre><span class="n">proc</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="s">'svn co svn+ssh://myrepo'</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">line</span>
</pre></div><p>This works, for the most part. But, again, if there is an error, you'll want to read <code>stderr</code> too. It would be nice to read <code>stdout</code> and <code>stderr</code> simultaneously. Just like a shell seems to be doing. Alas, this remains a not so straightforward problem as of today, at least on non-Linux systems.</p><p>On Linux (and where its supported), you can use the <a href="http://docs.python.org/library/select.html"><code>select</code></a> module to keep an eye on multiple file-like stream objects. But this isn't available on windows. A more platform independent solution that I found works well, is using threads and a <a href="http://docs.python.org/library/queue.html#queue-objects"><code>Queue</code></a>.</p><div class="codehilite"><pre><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Empty</span>

<span class="n">io_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">stream_watcher</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">io_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">identifier</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">stream</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">proc</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="s">'svn co svn+ssh://myrepo'</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>

<span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">stream_watcher</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'stdout-watcher'</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">'STDOUT'</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">stream_watcher</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'stderr-watcher'</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">'STDERR'</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">printer</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Block for 1 second.</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">io_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="c"># No output in either streams for a second. Are we done?</span>
            <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">identifier</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">print</span> <span class="n">identifier</span> <span class="o">+</span> <span class="s">':'</span><span class="p">,</span> <span class="n">line</span>

<span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">printer</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'printer'</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div><p>Fair bit of code. This is a typical producer-consumer thing. Two threads producing lines of output (one each from <code>stdout</code> and <code>stderr</code>) and pushing them into a queue. One thread watching the queue and printing the lines until the process itself finishes.</p><h1 id="passing-an-environment">Passing an environment</h1><p>The <code>env</code> argument to <code>Popen</code> (and others) lets you customize the environment of the command being run. If it is not set, or is set to <code>None</code>, the current process's environment is used, just as documented.</p><p>You might not agree with me, but I feel there are some subtleties with this argument that should have been mentioned in the documentation.</p><h2 id="merge-with-current-environment">Merge with current environment</h2><p>One is that if you provide a mapping to <code>env</code>, whatever is in this mapping is all that's available to the command being run. For example, if you don't give a <code>TOP_ARG</code> in the <code>env</code> mapping, the command won't see a <code>TOP_ARG</code> in its environment. So, I frequently find myself doing this</p><div class="codehilite"><pre><span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="s">'command'</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">my_env_prop</span><span class="o">=</span><span class="s">'value'</span><span class="p">))</span>
</pre></div><p>This makes sense once you realize it, but I wish it were at least <em>hinted at</em> in the documentation.</p><h2 id="unicode">Unicode</h2><p>Another one, is to do with Unicode (Surprise surprise!). And windows. If you use <code>unicode</code>s in the <code>env</code> mapping, you get an error saying you can <em>only</em> use strings in the environment mapping. The worst part about this error is that it only seems to happen on windows and not on Linux. If its an error to use <code>unicode</code>s in this place, I wish it break on both platforms.</p><p>This issue is very painful if you're like me and use <code>unicode</code><em>all the time</em>.</p><div class="codehilite"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
</pre></div><p>That line is present in all my python source files. The error message doesn't even bother to mention that you have <code>unicode</code>s in your <code>env</code> so it's very hard to understand what's going wrong.</p><h1 id="execute-in-a-different-working-directory">Execute in a different working directory</h1><p>This is handled by the <code>cwd</code> argument. You set the location of the directory which you want as the working directory of the program you are launching.</p><p>The docs do mention that the working directory is changed <em>before</em> the command even starts running. But that you <em>can't</em> specify program's path relative to the <code>cwd</code>. In reality, I found that you <em>can</em> do this.</p><p>Either I'm missing something with this or the docs really are inaccurate. Anyway, this works</p><div class="codehilite"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">'./ls'</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="s">'/bin'</span><span class="p">)</span>
</pre></div><p>Prints out all the files in <code>/bin</code>. Of course, the following doesn't work when the working directory is not <code>/bin</code>.</p><div class="codehilite"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">'./ls'</span><span class="p">)</span>
</pre></div><p>So, if you are giving something explicitly to <code>cwd</code> and are using a relative path for the executable, this is something to keep in mind.</p><h1 id="killing-and-dieing">Killing and dieing</h1><p>A simple</p><div class="codehilite"><pre><span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</pre></div><p>or for some dramatic umphh!</p><div class="codehilite"><pre><span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</pre></div><p>will do the trick to end the process. As noted in the documentation, the former sends a <code>SIGTERM</code> and later sends a <code>SIGKILL</code> on unix, but both do some native windows-y thing on windows.</p><h2 id="auto-kill-on-death">Auto-kill on death</h2><p>The processes you start in your python program, stay running even after your program exits. This is <em>usually</em> what you want, but when you want all your sub processes killed automatically on exit with <code>Ctrl+C</code> or the like, you have to use the <a href="http://docs.python.org/library/atexit.html"><code>atexit</code></a> module.</p><div class="codehilite"><pre><span class="n">procs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nd">@atexit.register</span>
<span class="k">def</span> <span class="nf">kill_subprocesses</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">:</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</pre></div><p>And add all the <code>Popen</code> objects created to the <code>procs</code> list. This is the only solution I found that works best.</p><h1 id="launch-commands-in-a-terminal-emulator">Launch commands in a terminal emulator</h1><p>On one occasion, I had to write a script that would launch multiple svn checkouts and then run many ant builds (~20-35) on the checked out projects. In my opinion, the best and easiest way to do this is to fire up multiple terminal emulator windows each running an individual checkout/ant-build. This allows us to monitor each process and even cancel any of them by simply closing the corresponding terminal emulator window.</p><h2 id="linux">Linux</h2><p>This is pretty trivial actually. On Linux, you can use <code>xterm</code> for this.</p><div class="codehilite"><pre><span class="n">Popen</span><span class="p">([</span><span class="s">'xterm'</span><span class="p">,</span> <span class="s">'-e'</span><span class="p">,</span> <span class="s">'sleep 3s'</span><span class="p">])</span>
</pre></div><h2 id="windows">Windows</h2><p>On windows, its not as straight forward. The first solution for this would be</p><div class="codehilite"><pre><span class="n">Popen</span><span class="p">([</span><span class="s">'cmd'</span><span class="p">,</span> <span class="s">'/K'</span><span class="p">,</span> <span class="s">'command'</span><span class="p">])</span>
</pre></div><blockquote><p><code>/K</code> option tells <code>cmd</code> to run the command and keep the command window from closing. You may use <code>/C</code> instead to close the command window after the command finishes.</p></blockquote><p>As simple as it looks, it has some weird behavior. I don't completely understand it, but I'll try to explain what I have. When you try to run a python script with the above <code>Popen</code> call, in a command window like this</p><div class="codehilite"><pre>python main.py
</pre></div><p>you <em>don't</em> see a new command window pop up. Instead, the sub command runs in the same command window. I have no idea what happens when you run multiple sub commands this way. (I have only limited access to windows).</p><p>If instead you run it in something like an IDE or IDLE (<kbd>F5</kbd>), you have a new command window open up. I believe one each for each command you run this way. Just the way you expect.</p><p>But I gave up on <code>cmd.exe</code> for this purpose and learnt to use the <a href="https://code.google.com/p/mintty/"><code>mintty</code></a> utility that comes with <a href="http://www.cygwin.com/">cygwin</a> (I think 1.7+). <code>mintty</code> is awesome. Really. Its been a while since I felt that way about a command line utility on windows.</p><div class="codehilite"><pre><span class="n">Popen</span><span class="p">([</span><span class="s">'mintty'</span><span class="p">,</span> <span class="s">'--hold'</span><span class="p">,</span> <span class="s">'error'</span><span class="p">,</span> <span class="s">'--exec'</span><span class="p">,</span> <span class="s">'command'</span><span class="p">])</span>
</pre></div><p>This. A new <code>mintty</code> console window opens up running the command and it closes automatically, <em>if</em> the command exits with zero status (that's what <code>--hold error</code> does). Otherwise, it stays on. Very useful.</p><h1 id="conclusion">Conclusion</h1><p>The subprocess module is a very useful thing. Spend some time understanding it better. This is my attempt at helping people with it, and turned out to be way longer than I'd expected. If there are any inaccuracies in this, or if you have anything to add, please leave a comment.</p><p></p><hr><div class="social-controls"><iframe src="index_1.html" title="Twitter Tweet Button" style="position: static; visibility: visible; width: 61px; height: 20px;" class="twitter-share-button twitter-share-button-rendered twitter-tweet-button" allowtransparency="true" scrolling="no" id="twitter-widget-0" frameborder="0"></iframe><iframe src="index_2.html" scrolling="no" frameborder="0" height="20" width="120"></iframe><iframe allowtransparency="true" marginwidth="0" marginheight="0" border="0" title="Flattr" scrolling="no" class="FlattrButton" src="index_3.html" frameborder="0" height="20" width="110"></iframe></div><h2>Comments</h2><div id="disqus_thread"><iframe verticalscrolling="no" horizontalscrolling="no" src="http://disqus.com/embed/comments/?base=default&amp;version=3e7d4d41055f837d35251d3347490375&amp;f=sharats-me&amp;t_u=http%3A%2F%2Fsharats.me%2Fthe-ever-useful-and-neat-subprocess-module.html&amp;t_d=(shrikant-sharat)&amp;t_t=(shrikant-sharat)&amp;s_o=default" style="width: 1px ! important; min-width: 100% ! important; border: medium none ! important; overflow: hidden ! important; height: 7327px ! important;" title="Disqus" tabindex="0" scrolling="no" allowtransparency="true" name="dsq-app2" id="dsq-app2" frameborder="0" width="100%"></iframe></div></article></article><footer><br><p><a href="http://sharats.me/">(shrikant-sharat)</a>&nbsp;Â© Shrikant Sharat Kandula 2013.</p></footer></section><iframe src="index_5.html" style="position: absolute; visibility: hidden; display: none; width: 0px; height: 0px; padding: 0px; border: medium none;" allowfullscreen="true" allowtransparency="true" scrolling="no" id="rufous-sandbox" frameborder="0"></iframe></body>
</html>
